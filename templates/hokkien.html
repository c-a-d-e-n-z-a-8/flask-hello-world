<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>閩南語隨機學習</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div id="start-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 9999;">
        <button id="initBtn" class="btn btn-lg btn-success px-5 py-3 fs-3">
            點擊<br>開始
        </button>
    </div>
    <div class="container-fluid py-5">
        <h1 class="mb-4 text-center text-primary">閩南語隨機學習</h1>
        <div class="row justify-content-center">
            <!-- 小螢幕佔滿 (col-12)，平板以上寬度佔10欄 -->
            <div class="col-12 col-md-10">
                <div class="card shadow">
                    <div class="card-body">
                        <button id="pauseBtn" class="btn btn-success mb-3 me-2">暫停自動轉換</button>
                        <button id="nextBtn" class="btn btn-primary mb-3">手動跳轉新詞</button>
                        <h5 class="card-title">
                            詞彙編號：
                            <a id="no-link" class="text-success" href="#" target="_blank">
                                <span id="no"></span>
                            </a>
                        </h5>
                        <div id="content" class="mb-3 fs-5"></div>
                        <!-- 預設隱藏 audio -->
                        <audio id="audio" controls autoplay class="w-100 d-none"></audio>
                    </div>
                </div>
                <div id="alert" class="alert alert-warning mt-3 d-none" role="alert">
                    查無資料，請稍後再試。
                </div>
            </div>
        </div>
    </div>
    <script>
        let intervalId = null;
        let isPaused = false;
        let current = 0;
        let audioLen = 0;

        // 動態設定自動更新時間
        function startAutoUpdate(timeout = 5000) {
            stopAutoUpdate();
            console.log(`S0 ${timeout}`)
            intervalId = setTimeout(() => {
                updateWord();
            }, timeout);
        }

        function stopAutoUpdate() {
            if (intervalId) {
                clearTimeout(intervalId);
                intervalId = null;
            }
        }

        function updateWord() {
            fetch('/api/random')
                .then(response => response.json())
                .then(data => {
                    // 1. 更新畫面文字
                    document.getElementById('no').innerText = data.no || '';
                    document.getElementById('no-link').href =
                        'https://sutian.moe.edu.tw/zh-hant/su/' + (data.no || '') + '/';
                    document.getElementById('content').innerHTML = data.html || '';
                    document.getElementById('alert').classList.toggle('d-none', !!data.no);

                    // 2. 建立播放清單 (只存網址)
                    let playlistUrls = [];

                    // (A) 主單字語音 (如果有)
                    if (data.audio_url) {
                        playlistUrls.push(data.audio_url);
                    }

                    // (B) 例句語音 (修正點：正確抓取 <source> 內的 src)
                    let subAudios = document.querySelectorAll('#content audio');
                    subAudios.forEach(el => {
                        let url = el.src; // 先試抓 audio src
                        
                        // 如果 audio 沒 src，就去抓裡面的 <source> 標籤
                        if (!url) {
                            let sourceTag = el.querySelector('source');
                            if (sourceTag) {
                                url = sourceTag.src;
                            }
                        }

                        if (url) {
                            playlistUrls.push(url);
                        }
                        
                        // 隱藏原本的播放器
                        el.style.display = 'none'; 
                    });

                    // 3. 取得主播放器
                    const mainPlayer = document.getElementById('audio');

                    // 如果完全沒聲音，3秒後換下一張
                    if (playlistUrls.length === 0) {
                        mainPlayer.classList.add('d-none');
                        startAutoUpdate(3000);
                        return;
                    }

                    // 4. 定義播放邏輯
                    let currentIndex = 0;

                    function playNext() {
                        if (currentIndex >= playlistUrls.length) {
                            // 全部播完
                            startAutoUpdate(3000);
                            return;
                        }

                        // 設定網址
                        mainPlayer.src = playlistUrls[currentIndex];
                        mainPlayer.classList.remove('d-none');

                        // 播放
                        let playPromise = mainPlayer.play();
                        
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                // 播放開始
                            }).catch(error => {
                                console.warn('播放失敗，跳過:', error);
                                currentIndex++;
                                playNext();
                            });
                        }

                        // 監聽結束事件
                        mainPlayer.onended = function() {
                            if (!isPaused) {
                                currentIndex++;
                                playNext();
                            }
                        };
                        
                        // 監聽錯誤事件
                        mainPlayer.onerror = function() {
                            console.warn('載入錯誤，跳過');
                            currentIndex++;
                            playNext();
                        }
                    }

                    // 5. 開始播放
                    playNext();
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    startAutoUpdate(3000);
                });
        }

        // 初始化
        //updateWord();
        
        // --- 修改部分開始：取代原本的 updateWord() ---       
        // 抓取頁面上既有的 audio 元素
        const mainAudio = document.getElementById('audio');

        document.getElementById('initBtn').addEventListener('click', function() {
            // 1. 隱藏遮罩
            document.getElementById('start-overlay').classList.add('d-none');

            // 2. 關鍵步驟：在使用者點擊的當下，對 audio 進行一次「空播放」
            // 這會告訴 iOS/Android 瀏覽器：「使用者允許這個網頁發出聲音」
            mainAudio.play().then(() => {
                mainAudio.pause();
            }).catch(() => {
                // 忽略空播放的錯誤
            });

            // 3. 執行原本的邏輯
            updateWord();
        });        
        // --- 修改部分結束 ---        

        document.getElementById('pauseBtn').addEventListener('click', function() {
            if (isPaused) {
                isPaused = false;
                // 重新啟動自動更新
                updateWord();
                this.textContent = '暫停自動轉換';
                this.classList.remove('btn-warning');
                this.classList.add('btn-success'); // 綠色
            } else {
                isPaused = true;
                stopAutoUpdate();
                this.textContent = '繼續自動轉換';
                this.classList.remove('btn-success');
                this.classList.add('btn-warning'); // 黃色
            }
        });

        document.getElementById('nextBtn').addEventListener('click', function() {
            updateWord();
        });
    </script>
</body>
</html>

